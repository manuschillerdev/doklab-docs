# Secrets Management

Securely inject secrets into your containers from encrypted sources like SOPS, HashiCorp Vault, AWS Secrets Manager, and more.

import { Tabs } from 'nextra/components'
import { Callout } from 'nextra/components'
import { Steps } from 'nextra/components'

## Overview

doklab uses the [vals](https://github.com/helmfile/vals) CLI for secret resolution, supporting multiple backends.

<Callout type="info">
  **Prerequisite**: The `vals` CLI must be installed. See [Installation](/docs/getting-started/installation#installing-vals) for instructions.
</Callout>

| Backend | Reference Format |
|---------|-----------------|
| **SOPS** | `ref+sops://file.yaml#/path` |
| **HashiCorp Vault** | `ref+vault://server/path#/key` |
| **AWS Secrets Manager** | `ref+awssecrets://secret-name#/key` |
| **GCP Secret Manager** | `ref+gcpsecrets://project/secret#/version` |
| **Azure Key Vault** | `ref+azurekeyvault://vault/secret` |

## Secret Types

### Environment Secrets

Inject secrets as environment variables:

```yaml filename="docker-compose.yml" {5-6}
services:
  api:
    image: myapp:latest
    labels:
      doklab.secret.env.DATABASE_URL: ref+sops://secrets.yaml#/database/url
      doklab.secret.env.API_KEY: ref+sops://secrets.yaml#/api_key
```

At runtime, these become:

```bash
DATABASE_URL=postgres://user:pass@host:5432/db
API_KEY=sk-abc123...
```

### File Secrets

Mount secrets as files in the container:

```yaml filename="docker-compose.yml" {5-9}
services:
  api:
    image: myapp:latest
    labels:
      # Mount a certificate
      doklab.secret.file.tls_cert: ref+sops://certs.yaml#/cert
      doklab.secret.file.tls_cert.mountPath: /etc/ssl/cert.pem

      # Mount a private key (base64 decoded)
      doklab.secret.file.tls_key: ref+sops://certs.yaml#/key
      doklab.secret.file.tls_key.mountPath: /etc/ssl/key.pem
      doklab.secret.file.tls_key.decodeFrom: base64
```

| Label Suffix | Description |
|--------------|-------------|
| `.mountPath` | Where to mount the file in the container |
| `.decodeFrom` | Decode from `base64` or `base64url` before writing |

### .env File Secrets

Reference secrets directly in your `.env` file:

```bash filename=".env"
# Plain values
DB_HOST=postgres
DB_NAME=myapp

# Resolved secrets
DB_PASSWORD=ref+sops://secrets.yaml#/database/password
JWT_SECRET=ref+vault://vault.example.com:8200/secret/jwt#/key
```

doklab resolves these before passing to Docker Compose.

## SOPS Setup

<Steps>
### Create an age key

doklab uses age encryption by default:

```bash
# Generated during doklab init
cat ~/.doklab/age.key
# AGE-SECRET-KEY-1...
```

### Configure SOPS

```yaml filename="~/.doklab/.sops.yaml"
creation_rules:
  - age: >-
      age1abc123...  # Your public key
```

### Create secrets file

```yaml filename="~/.doklab/secrets.yaml"
database:
  url: postgres://user:secretpassword@host:5432/db
  password: secretpassword

api_key: sk-abc123xyz789

tls:
  cert: |
    -----BEGIN CERTIFICATE-----
    MIIBkTCB+wIJAK...
    -----END CERTIFICATE-----
  key: |
    -----BEGIN PRIVATE KEY-----
    MIIEvgIBADANBg...
    -----END PRIVATE KEY-----
```

### Encrypt

```bash
sops -e -i ~/.doklab/secrets.yaml
```
</Steps>

## Using Vault

<Tabs items={['Token Auth', 'Kubernetes Auth']}>
  <Tabs.Tab>
    ```yaml filename="docker-compose.yml"
    labels:
      doklab.secret.env.DB_PASS: ref+vault://vault.example.com:8200/secret/myapp#/db_password
    ```

    Set the Vault token:

    ```bash
    export VAULT_TOKEN=hvs.abc123...
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```yaml filename="docker-compose.yml"
    labels:
      doklab.secret.env.DB_PASS: ref+vault://vault.example.com:8200/secret/myapp#/db_password?role=myapp-role
    ```
  </Tabs.Tab>
</Tabs>

## Using AWS Secrets Manager

```yaml filename="docker-compose.yml"
labels:
  doklab.secret.env.API_KEY: ref+awssecrets://myapp/api-key#/value
```

Requires AWS credentials in the environment:

```bash
export AWS_ACCESS_KEY_ID=...
export AWS_SECRET_ACCESS_KEY=...
export AWS_REGION=us-east-1
```

## Security Features

### RAM-Based Storage

On Linux, resolved file secrets are written to `/dev/shm/doklab-secrets/`:

- RAM-backed filesystem (tmpfs)
- Never touches disk
- Automatically cleaned after deployment

On macOS/other platforms, falls back to `~/.doklab/secrets/`.

### Secret Lifecycle

1. Secrets are resolved fresh on each deployment
2. Values are never logged or printed
3. Temporary files are cleaned up after `docker compose up`

<Callout type="warning">
  Never commit unencrypted secrets to Git! Always use SOPS or another encryption tool.
</Callout>

## Path Resolution

SOPS paths are resolved relative to your project directory:

```yaml
# Project at /home/user/projects/myapp/docker-compose.yml

# This looks for /home/user/projects/myapp/secrets.yaml
doklab.secret.env.KEY: ref+sops://secrets.yaml#/key

# Absolute paths also work
doklab.secret.env.KEY: ref+sops:///etc/secrets/global.yaml#/key
```

## Troubleshooting

### SOPS decryption fails

1. Check your age key exists:
   ```bash
   cat ~/.doklab/age.key
   ```

2. Verify the public key in `.sops.yaml` matches:
   ```bash
   age-keygen -y ~/.doklab/age.key
   ```

3. Check SOPS_AGE_KEY_FILE environment:
   ```bash
   echo $SOPS_AGE_KEY_FILE
   ```

### Vault connection issues

1. Verify connectivity:
   ```bash
   curl https://vault.example.com:8200/v1/sys/health
   ```

2. Check token permissions:
   ```bash
   vault token lookup
   ```

## Next Steps

- **[Backups](/docs/features/backups)** - Automated backup configuration
- **[Reference/Labels](/docs/reference/labels)** - Complete label reference
